/*
 * This file is automatically generated; any changes will be lost. 
 */

namespace ContactSync.OldApp.Publisher.Data;

/// <summary>
/// Enables the Change Data Capture (CDC) <see cref="ContactCdc"/> entity (aggregate root) orchestration (database table '[old].[Contact]').
/// </summary>
public partial interface IContactOrchestrator : IEntityOrchestrator<ContactCdc> { }

/// <summary>
/// Manages the Change Data Capture (CDC) <see cref="ContactCdc"/> entity (aggregate root) orchestration (database table '[old].[Contact]').
/// </summary>
public partial class ContactOrchestrator : EntityOrchestrator<ContactCdc, ContactOrchestrator.ContactCdcEnvelopeCollection, ContactOrchestrator.ContactCdcEnvelope, VersionTrackingMapper>, IContactOrchestrator
{
    private static readonly ContactCdcMapper _contactCdcMapper = new();
    private static readonly AddressCdcMapper _addressCdcMapper = new();

    /// <summary>
    /// Initializes a new instance of the <see cref="ContactOrchestrator"/> class.
    /// </summary>
    /// <param name="db">The <see cref="IDatabase"/>.</param>
    /// <param name="eventPublisher">The <see cref="IEventPublisher"/>.</param>
    /// <param name="jsonSerializer">The <see cref="IJsonSerializer"/>.</param>
    /// <param name="settings">The <see cref="SettingsBase"/>.</param>
    /// <param name="logger">The <see cref="ILogger"/>.</param>
    public ContactOrchestrator(IDatabase db, IEventPublisher eventPublisher, IJsonSerializer jsonSerializer, SettingsBase settings, ILogger<ContactOrchestrator> logger) :
        base(db, "[NTangle].[spContactBatchExecute]", "[NTangle].[spContactBatchComplete]", eventPublisher, jsonSerializer, settings, logger) => ContactOrchestratorCtor();

    partial void ContactOrchestratorCtor(); // Enables additional functionality to be added to the constructor.

    /// <inheritdoc/>
    protected override async Task<EntityOrchestratorResult<ContactCdcEnvelopeCollection, ContactCdcEnvelope>> GetBatchEntityDataAsync(CancellationToken cancellationToken = default)
    {
        var cColl = new ContactCdcEnvelopeCollection();

        var result = await SelectQueryMultiSetAsync(MultiSetArgs.Create(
            // Root table: '[old].[contact]'
            new MultiSetCollArgs<ContactCdcEnvelopeCollection, ContactCdcEnvelope>(_contactCdcMapper, __result => cColl = __result, stopOnNull: true),

            // Join table: '[old].[contact_address]' (unique name 'Address')
            new MultiSetCollArgs<ContactCdc.AddressCdcCollection, ContactCdc.AddressCdc>(_addressCdcMapper, __result =>
            {
                foreach (var a in __result.GroupBy(x => new { x.Id }).Select(g => new { g.Key.Id, Coll = g.ToCollection<ContactCdc.AddressCdcCollection, ContactCdc.AddressCdc>() }))
                {
                    cColl.Where(x => x.ContactAddressid == a.Id).ForEach(x => x.Address = a.Coll.FirstOrDefault());
                }
            })), cancellationToken).ConfigureAwait(false);

        result.Result.AddRange(cColl);
        return result;
    }

    /// <inheritdoc/>
    protected override string EventSubject => "old.Contact";

    /// <inheritdoc/>
    protected override EventSubjectFormat EventSubjectFormat => EventSubjectFormat.NameOnly;

    /// <inheritdoc/>
    protected override EventActionFormat EventActionFormat => EventActionFormat.PastTense;

    /// <inheritdoc/>
    protected override string? EventType => "old.Contact";

    /// <inheritdoc/>
    protected override Uri? EventSource => new("/database/cdc/old/contact", UriKind.Relative);

    /// <inheritdoc/>
    protected override EventSourceFormat EventSourceFormat { get; } = EventSourceFormat.NameAndTableKey;

    /// <summary>
    /// Represents a <see cref="ContactCdc"/> envelope to append the required (additional) database properties.
    /// </summary>
    public class ContactCdcEnvelope : ContactCdc, IEntityEnvelope
    {
        /// <inheritdoc/>
        [JsonIgnore]
        public CdcOperationType DatabaseOperationType { get; set; }

        /// <inheritdoc/>
        [JsonIgnore]
        public byte[] DatabaseLsn { get; set; } = Array.Empty<byte>();

        /// <inheritdoc/>
        [JsonIgnore]
        public string? DatabaseTrackingHash { get; set; }

        /// <inheritdoc/>
        [JsonIgnore]
        public bool IsDatabasePhysicallyDeleted { get; set; }
    }

    /// <summary>
    /// Represents a <see cref="ContactCdcEnvelope"/> collection.
    /// </summary>
    public class ContactCdcEnvelopeCollection : List<ContactCdcEnvelope> { }

    /// <summary>
    /// Represents a <see cref="ContactCdc"/> database mapper.
    /// </summary>
    public class ContactCdcMapper : IDatabaseMapper<ContactCdcEnvelope>
    {
        /// <inheritdoc/>
        public ContactCdcEnvelope? MapFromDb(DatabaseRecord record, OperationTypes operationType) => new()
        {
            Id = record.GetValue<int>("Id"),
            Name = record.GetValue<string?>("Name"),
            Phone = record.GetValue<string?>("Phone"),
            Email = record.GetValue<string?>("Email"),
            IsActive = record.GetValue<bool?>("IsActive"),
            NoCallList = record.GetValue<bool?>("NoCallList"),
            ContactAddressid = record.GetValue<int?>("ContactAddressid"),
            DatabaseOperationType = record.GetValue<CdcOperationType>(CdcOperationTypeColumnName),
            DatabaseLsn = record.GetValue<byte[]>(CdcLsnColumnName),
            DatabaseTrackingHash = record.GetValue<string?>(TrackingHashColumnName),
            IsDatabasePhysicallyDeleted = record.GetValue<bool>(IsPhysicallyDeletedColumnName)
        };

        /// <inheritdoc/>
        void IDatabaseMapper<ContactCdcEnvelope>.MapToDb(ContactCdcEnvelope? value, DatabaseParameterCollection parameters, OperationTypes operationType) => throw new NotImplementedException();
    }

    /// <summary>
    /// Represents a <see cref="AddressCdc"/> database mapper.
    /// </summary>
    public class AddressCdcMapper : IDatabaseMapper<ContactCdc.AddressCdc>
    {
        /// <inheritdoc/>
        public ContactCdc.AddressCdc? MapFromDb(DatabaseRecord record, OperationTypes operationType) => new()
        {
            Id = record.GetValue<int>("Id"),
            Street1 = record.GetValue<string?>("Street1"),
            Street2 = record.GetValue<string?>("Street2")
        };

        /// <inheritdoc/>
        void IDatabaseMapper<ContactCdc.AddressCdc>.MapToDb(ContactCdc.AddressCdc? value, DatabaseParameterCollection parameters, OperationTypes operationType) => throw new NotImplementedException();
    }
}