{{! Copyright (c) Avanade. Licensed under the MIT License. See https://github.com/Avanade/NTangle }}
/*
 * This file is automatically generated; any changes will be lost. 
 */

namespace {{Root.NamespacePublisher}}.Data;

/// <summary>
/// Enables the Change Data Capture (CDC) <see cref="{{Model}}Cdc"/> entity (aggregate root) orchestration (database table '[{{Schema}}].[{{Name}}]').
/// </summary>
public partial interface I{{Model}}Orchestrator : IEntityOrchestrator<{{Model}}Cdc> { }

/// <summary>
/// Manages the Change Data Capture (CDC) <see cref="{{Model}}Cdc"/> entity (aggregate root) orchestration (database table '[{{Schema}}].[{{Name}}]').
/// </summary>
public partial class {{Model}}Orchestrator : EntityOrchestrator<{{Model}}Cdc, {{Model}}Orchestrator.{{Model}}CdcEnvelopeCollection, {{Model}}Orchestrator.{{Model}}CdcEnvelope, VersionTrackingMapper{{#if UsesGlobalIdentifier}}, {{Root.IdentifierMappingDotNetType}}{{/if}}>, I{{Model}}Orchestrator
{
    private static readonly {{Model}}CdcMapper _{{camel Model}}CdcMapper = new();
{{#each DistinctModels}}
    private static readonly {{Model}}CdcMapper _{{camel Model}}CdcMapper = new();
{{/each}}
{{#each OrchestratorCtorParameters}}
  {{#if @first}}

  {{/if}}
    private readonly {{Type}} {{PrivateName}};
{{/each}}

    /// <summary>
    /// Initializes a new instance of the <see cref="{{Model}}Orchestrator"/> class.
    /// </summary>
    /// <param name="db">The <see cref="{{Database}}"/>.</param>
    /// <param name="eventPublisher">The <see cref="IEventPublisher"/>.</param>
    /// <param name="jsonSerializer">The <see cref="IJsonSerializer"/>.</param>
    /// <param name="settings">The <see cref="SettingsBase"/>.</param>
    /// <param name="logger">The <see cref="ILogger"/>.</param>
{{#if UsesGlobalIdentifier}}
    /// <param name="idGen">The <see cref="IIdentifierGenerator{T}"/>.</param>
{{/if}}
{{#each OrchestratorCtorParameters}}
    /// <param name="{{ArgumentName}}">{{{Text}}}</param>
{{/each}}
    public {{Model}}Orchestrator({{Database}} db, IEventPublisher eventPublisher, IJsonSerializer jsonSerializer, SettingsBase settings, ILogger<{{Model}}Orchestrator> logger{{#if UsesGlobalIdentifier}}, IIdentifierGenerator<{{Root.IdentifierMappingDotNetType}}> idGen{{/if}}{{#each OrchestratorCtorParameters}}, {{Type}} {{ArgumentName}}{{/each}}) :
        base(db, "[{{CdcSchema}}].[{{ExecuteStoredProcedure}}]", "[{{CdcSchema}}].[{{CompleteStoredProcedure}}]", eventPublisher, jsonSerializer, settings, logger{{#if UsesGlobalIdentifier}}, "[{{Root.CdcSchema}}].[{{Root.IdentifierMappingStoredProcedure}}]", idGen, new IdentifierMappingMapper<{{Root.IdentifierMappingDotNetType}}>(){{/if}}){{#ifeq OrchestratorCtorParameters.Count 0}} => {{Model}}OrchestratorCtor();{{/ifeq}}
{{#ifne OrchestratorCtorParameters.Count 0}}
    {
  {{#each OrchestratorCtorParameters}}
        {{PrivateName}} = {{ArgumentName}} ?? throw new ArgumentNullException(nameof({{ArgumentName}}));
  {{/each}}
        {{Model}}OrchestratorCtor();
    }
{{/ifne}}

    partial void {{Model}}OrchestratorCtor(); // Enables additional functionality to be added to the constructor.

    /// <inheritdoc/>
    protected override async Task<EntityOrchestratorResult<{{Model}}CdcEnvelopeCollection, {{Model}}CdcEnvelope>> GetBatchEntityDataAsync(CancellationToken cancellationToken = default)
    {
        var {{Alias}}Coll = new {{Model}}CdcEnvelopeCollection();

        var result = await SelectQueryMultiSetAsync(MultiSetArgs.Create(
            // Root table: '[{{Schema}}].[{{Table}}]'
            new MultiSetCollArgs<{{Model}}CdcEnvelopeCollection, {{Model}}CdcEnvelope>(_{{camel Model}}CdcMapper, __result => {{Alias}}Coll = __result, stopOnNull: true){{#ifne CdcJoins.Count 0}},{{else}}), cancellationToken).ConfigureAwait(false);{{/ifne}}
{{#each CdcJoins}}

            // Join table: '[{{Schema}}].[{{Table}}]' (unique name '{{Name}}')
            new MultiSetCollArgs<{{Parent.Model}}Cdc.{{Model}}CdcCollection, {{Parent.Model}}Cdc.{{Model}}Cdc>(_{{camel Model}}CdcMapper, __result =>
            {
  {{#each JoinHierarchyReverse}}
               {{indent IndentSpaces}} foreach (var {{Alias}} in {{#if @first}}__result{{else}}{{HierarchyChild.Alias}}{{/if}}{{#unless @first}}.Coll{{/unless}}.GroupBy(x => new { {{#each OnSelectColumns}}{{#unless @last}}, {{/unless}}x.{{#if @../../first}}{{NameAlias}}{{else}}{{#if @../last}}{{NameAlias}}{{else}}{{pascal Parent.JoinTo}}_{{NameAlias}}{{/if}}{{/if}}{{/each}} }).Select(g => new { {{#each OnSelectColumns}}{{#unless @last}}, {{/unless}}g.Key.{{#if @../../first}}{{NameAlias}}{{else}}{{#if @../last}}{{NameAlias}}{{else}}{{pascal Parent.JoinTo}}_{{NameAlias}}{{/if}}{{/if}}{{/each}}, Coll = g.{{#if @last}}ToCollection<{{../Parent.Model}}Cdc.{{../Model}}CdcCollection, {{../Parent.Model}}Cdc.{{../Model}}Cdc>{{else}}ToList{{/if}}() }))
               {{indent IndentSpaces}} {
    {{#unless @last}}
               {{indent IndentSpaces}}     var {{#ifval HierarchyChild}}{{HierarchyChild.Alias}}{{else}}{{Parent.Alias}}{{/ifval}}Item = {{#ifval HierarchyChild}}{{HierarchyChild.Alias}}{{else}}{{Parent.Alias}}{{/ifval}}Coll.First(x => {{#each OnSelectColumns}}{{#unless @last}} && {{/unless}}x.{{ToColumnAlias}} == {{Parent.Alias}}.{{#if @../last}}{{ToColumnAlias}}{{else}}{{pascal Parent.JoinTo}}_{{NameAlias}}{{/if}}{{/each}}).{{Property}} ?? new();
    {{else}}
               {{indent IndentSpaces}}     {{#if @first}}{{Parent.Alias}}Coll{{else}}{{#ifnull HierarchyChild.HierarchyChild}}{{Parent.Alias}}{{else}}HierarchyChild.HierarchyChild.Alias{{/ifnull}}Item{{/if}}.Where(x => {{#each OnSelectColumns}}{{#unless @last}} && {{/unless}}x.{{ToColumnAlias}} == {{Parent.Alias}}.{{#if @../../first}}{{NameAlias}}{{else}}{{#if @../last}}{{NameAlias}}{{else}}{{pascal Parent.JoinTo}}_{{NameAlias}}{{/if}}{{/if}}{{/each}}).ForEach(x => x.{{Property}} = {{Alias}}.Coll{{#ifeq JoinCardinality 'OneToOne'}}.FirstOrDefault(){{/ifeq}});
    {{/unless}}
  {{/each}}
  {{#each JoinHierarchy}}
               {{indent IndentSpaces}} }
  {{/each}}
            }){{#if @last}}), cancellationToken).ConfigureAwait(false);{{else}},{{/if}}
{{/each}}

        result.Result.AddRange({{Alias}}Coll);
        return result;
    }

    /// <inheritdoc/>
    protected override string EventSubject => "{{#ifval Root.EventSubjectRoot}}{{Root.EventSubjectRoot}}.{{/ifval}}{{EventSubject}}";

    /// <inheritdoc/>
    protected override EventSubjectFormat EventSubjectFormat => EventSubjectFormat.{{EventSubjectFormat}};

    /// <inheritdoc/>
    protected override EventActionFormat EventActionFormat => EventActionFormat.{{Root.EventActionFormat}};

    /// <inheritdoc/>
    protected override string? EventType => "{{#ifval Root.EventTypeRoot}}{{Root.EventTypeRoot}}.{{/ifval}}{{EventType}}";

{{#ifne Root.EventSourceKind 'None'}}
    /// <inheritdoc/>
    protected override Uri? EventSource => new("{{EventSourceUri}}", UriKind.{{Root.EventSourceKind}});

    /// <inheritdoc/>
    protected override EventSourceFormat EventSourceFormat { get; } = EventSourceFormat.{{EventSourceFormat}};

{{/ifne}}
{{#ifne ExcludePropertiesFromETag.Count 0}}
    /// <inheritdoc/>
    protected override string[]? ExcludePropertiesFromETag => new string[] { {{#each ExcludePropertiesFromETag}}"{{.}}"{{#unless @last}}, {{/unless}}{{/each}} };

{{/ifne}}
    /// <summary>
    /// Represents a <see cref="{{Model}}Cdc"/> envelope to append the required (additional) database properties.
    /// </summary>
    public class {{Model}}CdcEnvelope : {{Model}}Cdc, IEntityEnvelope
    {
        /// <inheritdoc/>
        [JsonIgnore]
        public CdcOperationType DatabaseOperationType { get; set; }

        /// <inheritdoc/>
        [JsonIgnore]
        public byte[] DatabaseLsn { get; set; } = Array.Empty<byte>();

        /// <inheritdoc/>
        [JsonIgnore]
        public string? DatabaseTrackingHash { get; set; }

        /// <inheritdoc/>
        [JsonIgnore]
        public bool IsDatabasePhysicallyDeleted { get; set; }
    }

    /// <summary>
    /// Represents a <see cref="{{Model}}CdcEnvelope"/> collection.
    /// </summary>
    public class {{Model}}CdcEnvelopeCollection : List<{{Model}}CdcEnvelope> { }

    /// <summary>
    /// Represents a <see cref="{{Model}}Cdc"/> database mapper.
    /// </summary>
    public class {{Model}}CdcMapper : IDatabaseMapper<{{Model}}CdcEnvelope>
    {
        /// <inheritdoc/>
        public {{Model}}CdcEnvelope? MapFromDb(DatabaseRecord record, OperationTypes operationType) => new()
        {
{{#if IdentifierMapping}}
            GlobalId = record.GetValue<{{Root.IdentifierMappingDotNetType}}?>("GlobalId"),
{{/if}}
{{#each SelectedEntityColumns}}
            {{pascal NameAlias}} = record.GetValue<{{DotNetType}}{{#if IsDotNetNullable}}?{{/if}}>("{{pascal NameAlias}}"),
{{/each}}
{{#each JoinNonCdcChildren}}
  {{#each Columns}}
            {{pascal NameAlias}} = record.GetValue<{{DotNetType}}{{#if IsDotNetNullable}}?{{/if}}>("{{pascal NameAlias}}"),
  {{/each}}
{{/each}}
            DatabaseOperationType = record.GetValue<CdcOperationType>(CdcOperationTypeColumnName),
            DatabaseLsn = record.GetValue<byte[]>(CdcLsnColumnName),
            DatabaseTrackingHash = record.GetValue<string?>(TrackingHashColumnName),
            IsDatabasePhysicallyDeleted = record.GetValue<bool>(IsPhysicallyDeletedColumnName)
        };

        /// <inheritdoc/>
        void IDatabaseMapper<{{Model}}CdcEnvelope>.MapToDb({{Model}}CdcEnvelope? value, DatabaseParameterCollection parameters, OperationTypes operationType) => throw new NotImplementedException();
    }
{{#each DistinctModels}}

    /// <summary>
    /// Represents a <see cref="{{Model}}Cdc"/> database mapper.
    /// </summary>
    public class {{Model}}CdcMapper : IDatabaseMapper<{{Parent.Model}}Cdc.{{Model}}Cdc>
    {
        /// <inheritdoc/>
        public {{Parent.Model}}Cdc.{{Model}}Cdc? MapFromDb(DatabaseRecord record, OperationTypes operationType) => new()
        {
  {{#each JoinHierarchyReverse}}
    {{#unless @last}}
      {{#each OnSelectColumns}}
            {{pascal Parent.JoinTo}}_{{NameAlias}} = record.GetValue<{{ToDbColumn.DotNetType}}>("{{pascal Parent.JoinTo}}_{{NameAlias}}"),
      {{/each}}
    {{/unless}}
  {{/each}}
  {{#each Columns}}
            {{pascal NameAlias}} = record.GetValue<{{DotNetType}}{{#if IsDotNetNullable}}?{{/if}}>("{{pascal NameAlias}}"){{#unless @last}},{{else}}{{#ifne Parent.JoinNonCdcChildren.Count 0}},{{/ifne}}{{/unless}}
  {{/each}}
  {{#each JoinNonCdcChildren}}
      {{#each Columns}}
            {{pascal NameAlias}} = record.GetValue<{{DotNetType}}{{#if IsDotNetNullable}}?{{/if}}>("{{pascal NameAlias}}"){{#unless @last}},{{else}}{{#unless ../@last}},{{/unless}}{{/unless}}
      {{/each}}
  {{/each}}
        };

        /// <inheritdoc/>
        void IDatabaseMapper<{{Parent.Model}}Cdc.{{Model}}Cdc>.MapToDb({{Parent.Model}}Cdc.{{Model}}Cdc? value, DatabaseParameterCollection parameters, OperationTypes operationType) => throw new NotImplementedException();
    }
{{/each}}
}